# SmallRAG 系统架构设计文档

## 1. 系统概览

SmallRAG 是一个轻量级的检索增强生成（Retrieval-Augmented Generation, RAG）系统，采用 **FastAPI 作为后端 API 服务**，**Gradio 构建前端交互界面**，并基于 **Elasticsearch** 与 **SQLite** 实现混合数据存储与向量检索能力。系统支持：

- 多用户注册登录与权限隔离
- 多工作区（Workspace）管理
- 文档上传、分块、嵌入向量生成与存储
- 基于文本与向量的混合检索（Hybrid Search）
- 问答历史记录与对话管理
- 图片嵌入与多模态检索（文本+向量）

---

## 2. 技术栈

| 层级 | 技术/组件 |
|------|----------|
| **后端框架** | FastAPI |
| **前端框架** | Gradio |
| **向量数据库** | Elasticsearch（`dense_vector` + `ik_max_word` 中文分词）|
| **关系数据库** | SQLite（通过 SQLAlchemy ORM）|
| **数据验证** | Pydantic v2 |
| **安全** | Werkzeug 密码哈希（`generate_password_hash`）|
| **嵌入维度** | 文本：768维，图像：512维 |
| **分词器** | `ik_max_word`（全文检索），`ik_smart`（QA 精确检索）|

---

## 3. 核心模块设计

### 3.1 数据模型（Pydantic + SQLAlchemy）

#### (1) 用户与元数据模型（SQLite ORM）
| 模型 | 说明 |
|------|------|
| `User` | 用户账户，含哈希密码、创建时间 |
| `Workspace` | 用户创建的工作区，隔离文档空间 |
| `Document` | 上传文档元数据（路径、状态、哈希等） |
| `Conversation` | 聊天对话历史，以 JSON 存储消息列表 |

> ✅ **关系**：`User → Workspace → Document`；`User → Conversation`

#### (2) 检索数据模型（Pydantic + Elasticsearch）
| 模型 | 索引名 | 功能 |
|------|--------|------|
| `DocumentMeta` | `smallrag_document_meta` | 存储完整文档元信息，支持全文检索 |
| `ChunkInfo` | `smallrag_chunk_info` | 文本分块 + 768 维嵌入向量 + `chunk_order`/`page_number` |
| `QAHistory` | `smallrag_qa_history` | 用户问答对 + 双向嵌入（question & concat） |
| `ImageInfo` | `smallrag_image_info` | 图像元数据 + 512 维嵌入 + `tags`（keyword 类型） |

> ✅ 所有模型均自动序列化 `datetime` 为 ISO 8601 字符串  
> ✅ 字段类型严格匹配 ES mapping（如 `tags` 为 `keyword`）

---

### 3.2 存储架构

#### 双数据库协同
| 数据库 | 职责 |
|--------|------|
| **SQLite** | 用户管理、工作区组织、文档生命周期状态、对话历史（结构化关系数据） |
| **Elasticsearch** | 高性能全文检索 + 向量相似性搜索（非结构化/半结构化内容）|

> 🔁 **数据同步**：文档上传后，由后端服务将分块内容与嵌入写入 ES，同时更新 SQLite 中的 `embedding_status`

---

### 3.3 检索能力

#### (1) 全文检索（BM25）
- 使用 `ik_max_word` 分词器，支持中英文混合
- 可按 `workspace_id` 和 `user_username` 过滤结果

#### (2) 向量检索（KNN）
- `chunk` 和 `image` 索引启用 `dense_vector` + `cosine similarity`
- 支持 `knn` 查询 + 过滤（`filter` 条件限制用户/工作区）

#### (3) 混合检索（Hybrid Search）
```python
hybrid_search_chunks(
    text_query="气候变化的影响",
    vector_query=[0.1, -0.5, ..., 0.3],  # 768维
    workspace_id="proj_001",
    username="alice"
)
```
返回两类结果：
- `text_hits`：基于关键词匹配的 top-k 分块
- `vector_hits`：基于语义相似度的 top-k 分块

---

### 3.4 安全与异常处理

- **密码安全**：使用 `werkzeug.security` 哈希存储
- **输入校验**：
  - 用户名：仅允许字母、数字、下划线
  - 密码确认：自动校验一致性
- **ES 异常统一捕获**：通过 `@safe_es_call` 装饰器处理连接失败、404、传输错误等
- **日志记录**：关键操作记录 INFO/ERROR 日志

---

## 4. API 与接口设计（FastAPI）

### 主要端点（示意）
| 方法 | 路径 | 功能 |
|------|------|------|
| POST | `/auth/register` | 用户注册 |
| POST | `/auth/login` | 用户登录 |
| POST | `/workspace/create` | 创建工作区 |
| POST | `/document/upload` | 上传文件并触发分块/嵌入 |
| POST | `/chat/query` | 发起 RAG 查询（调用 hybrid_search） |
| GET  | `/chat/history` | 获取对话列表 |

> 📌 实际 FastAPI 路由未在代码中展示，但模型已为接口做好准备

---

## 5. 前端交互（Gradio）

- 使用 Gradio 构建聊天界面：
  - 左侧：工作区选择 + 文档列表
  - 中部：聊天窗口（支持多轮对话）
  - 右侧：检索结果预览（文本分块 + 相关图片）
- 通过 FastAPI 提供的 RESTful API 与后端通信

---

## 6. 扩展性与未来方向

- ✅ **模块化设计**：`SmallRAGDB` 类封装所有 ES 操作，易于替换为其他向量数据库
- ✅ **批量操作支持**：提供 `bulk_create_chunks` 提升导入效率
- 🔜 **多模态支持**：已预留图像嵌入与 `caption`/`tags` 检索能力
- 🔜 **工作区级权限**：可通过 `workspace_id` 实现更细粒度访问控制

---

## 7. 总结

SmallRAG 是一个**面向中小规模场景的轻量级 RAG 系统**，融合了：

- **结构化用户/文档管理**（SQLite + SQLAlchemy）
- **高性能混合检索**（Elasticsearch + dense_vector + ik 分词）
- **现代 Python 工程实践**（Pydantic v2 + FastAPI + Gradio）

适用于文档问答、知识库检索、多模态内容探索等场景，具备良好的可维护性与扩展潜力。